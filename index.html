<!DOCTYPE html>
<html>
<head>
  <title>Friend Chat System</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }

    .main-container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 350px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      color: white;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .sidebar-header h2 {
      font-size: 24px;
      font-weight: 600;
      color: #00cc99;
    }

    .sidebar-header i {
      margin-right: 10px;
    }

    /* Search Section */
    .search-section {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-box {
      position: relative;
      margin-bottom: 15px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: none;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }

    .search-box input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .search-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.6);
    }

    /* Chat Options */
    .chat-options {
      padding: 20px 0;
      flex: 1;
    }

    .chat-option {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      margin-bottom: 5px;
    }

    .chat-option:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: #00cc99;
    }

    .chat-option.active {
      background: rgba(0, 204, 153, 0.2);
      border-left-color: #00cc99;
    }

    .chat-icon {
      width: 45px;
      height: 45px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 18px;
      color: white;
    }

    .chat-icon.global {
      background: linear-gradient(135deg, #00cc99, #00ffaa);
    }

    .chat-icon.youtube {
      background: linear-gradient(135deg, #ff0000, #ff4444);
    }

    .chat-icon.spotify {
      background: linear-gradient(135deg, #1DB954, #1ED760);
    }

    .chat-icon.friends {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .chat-icon.ai {
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
    }

    .chat-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .chat-info p {
      font-size: 12px;
      opacity: 0.7;
    }

    /* Online Users Section */
    .online-users {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .online-users h4 {
      margin-bottom: 15px;
      font-size: 16px;
      color: #00cc99;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .users-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .online-user {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .online-user:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      background: linear-gradient(135deg, #00cc99, #00ffaa);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }

    .user-details {
      flex: 1;
    }

    .user-details .username {
      font-size: 14px;
      font-weight: 600;
      color: white;
    }

    .user-details .country {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
    }

    .online-indicator {
      width: 8px;
      height: 8px;
      background: #00cc99;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* User Profile Section */
    .user-profile {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #00cc99, #00ffaa);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }

    .profile-info h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .profile-info p {
      font-size: 11px;
      opacity: 0.7;
    }

    .logout-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 107, 107, 0.2);
    }

    /* Main Chat Area */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
    }

    .welcome-screen {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
    }

    .welcome-content {
      max-width: 600px;
    }

    .welcome-icon {
      font-size: 80px;
      color: #00cc99;
      margin-bottom: 30px;
    }

    .welcome-content h1 {
      font-size: 48px;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .welcome-content p {
      font-size: 18px;
      opacity: 0.8;
      margin-bottom: 40px;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 40px;
    }

    .feature-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px 20px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease;
    }

    .feature-card:hover {
      transform: translateY(-5px);
    }

    .feature-card i {
      font-size: 40px;
      margin-bottom: 15px;
      display: block;
    }

    .feature-card h3 {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .feature-card p {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Chat Interface */
    .chat-interface {
      height: 100%;
      display: flex;
      flex-direction: column;
      display: none;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }

    .chat-title {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: 600;
    }

    .chat-title i {
      margin-right: 10px;
      font-size: 24px;
    }

    .online-count {
      background: rgba(0, 204, 153, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      margin-left: 10px;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 70%;
      animation: fadeIn 0.3s ease;
    }

    .message.user-message {
      align-self: flex-end;
    }

    .message.other-message,
    .message.system-message {
      align-self: flex-start;
    }

    .message-content {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .message.user-message .message-content {
      background: linear-gradient(135deg, #00cc99, #00ffaa);
      color: white;
    }

    .message.other-message .message-content {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .message.system-message .message-content {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .message-header i {
      margin-right: 8px;
    }

    .sender {
      font-weight: 600;
      margin-right: 10px;
    }

    .country {
      background: rgba(0, 204, 153, 0.2);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 10px;
      color: #00cc99;
      font-weight: 600;
      margin-right: 10px;
    }

    .time {
      opacity: 0.7;
      font-size: 12px;
    }

    .message-text {
      line-height: 1.5;
    }

    .chat-footer {
      display: flex;
      padding: 20px;
      gap: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-footer input {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
      backdrop-filter: blur(10px);
    }

    .chat-footer input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .chat-footer input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
    }

    .chat-footer button {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #00cc99, #00ffaa);
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .chat-footer button:hover {
      transform: scale(1.1);
    }

    /* Auth Container */
    .auth-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      z-index: 1000;
    }

    .auth-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      color: white;
      text-align: center;
      width: 400px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .auth-header {
      margin-bottom: 30px;
    }

    .auth-header i {
      font-size: 48px;
      color: #00cc99;
      margin-bottom: 20px;
      display: block;
    }

    .auth-header h2 {
      font-size: 28px;
      font-weight: 600;
    }

    .auth-box input {
      width: 100%;
      margin: 15px 0;
      padding: 15px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
    }

    .auth-box input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .auth-box input:focus {
      outline: none;
      border-color: #00cc99;
    }

    .auth-btn {
      width: 100%;
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #00cc99, #00ffaa);
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.3s ease;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
    }

    .auth-btn i {
      margin-right: 8px;
    }

    .auth-box p {
      margin-top: 20px;
      opacity: 0.8;
    }

    .auth-box span {
      color: #00cc99;
      cursor: pointer;
      text-decoration: underline;
      font-weight: 600;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Scrollbar Styles */
    .chat-body::-webkit-scrollbar,
    .users-list::-webkit-scrollbar {
      width: 6px;
    }

    .chat-body::-webkit-scrollbar-track,
    .users-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .chat-body::-webkit-scrollbar-thumb,
    .users-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    .chat-body::-webkit-scrollbar-thumb:hover,
    .users-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        width: 280px;
      }
      
      .feature-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .welcome-content h1 {
        font-size: 32px;
      }
      
      .auth-box {
        width: 90%;
        margin: 20px;
      }
      
      .message {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <!-- Main Layout -->
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-comments"></i> Friend Chat</h2>
      </div>
      
      <!-- Search Section -->
      <div class="search-section">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search users...">
          <i class="fas fa-search"></i>
        </div>
      </div>
      
      <!-- Chat Options -->
      <div class="chat-options">
        <div class="chat-option" onclick="openGlobalChat()">
          <div class="chat-icon global">
            <i class="fas fa-globe-americas"></i>
          </div>
          <div class="chat-info">
            <h3>Global Chat</h3>
            <p>Chat with people worldwide</p>
          </div>
        </div>
        
        <div class="chat-option" onclick="openYouTube()">
          <div class="chat-icon youtube">
            <i class="fab fa-youtube"></i>
          </div>
          <div class="chat-info">
            <h3>YouTube</h3>
            <p>Watch videos</p>
          </div>
        </div>
        
        <div class="chat-option" onclick="openSpotify()">
          <div class="chat-icon spotify">
            <i class="fab fa-spotify"></i>
          </div>
          <div class="chat-info">
            <h3>Spotify</h3>
            <p>Listen to music</p>
          </div>
        </div>
        
        <div class="chat-option" onclick="openFriendChat()">
          <div class="chat-icon friends">
            <i class="fas fa-users"></i>
          </div>
          <div class="chat-info">
            <h3>Friends Chat</h3>
            <p>Private conversations</p>
          </div>
        </div>
        
        <div class="chat-option" onclick="openAIChat()">
          <div class="chat-icon ai">
            <i class="fas fa-robot"></i>
          </div>
          <div class="chat-info">
            <h3>AI Assistant</h3>
            <p>Smart conversations</p>
          </div>
        </div>
      </div>
      
      <!-- Online Users -->
      <div class="online-users">
        <h4><i class="fas fa-circle"></i> Online Users</h4>
        <div class="users-list" id="usersList"></div>
      </div>
      
      <!-- User Profile -->
      <div class="user-profile">
        <div class="profile-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="profile-info">
          <h4 id="userName">Guest User</h4>
          <p id="userCountry">Unknown</p>
        </div>
        <button onclick="logout()" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-container">
      <!-- Welcome Screen -->
      <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
          <div class="welcome-icon">
            <i class="fas fa-comments"></i>
          </div>
          <h1>Welcome to Friend Chat</h1>
          <p>Connect with friends and chat globally</p>
          <div class="feature-grid">
            <div class="feature-card">
              <i class="fas fa-globe-americas"></i>
              <h3>Global Chat</h3>
              <p>Chat with people worldwide</p>
            </div>
            <div class="feature-card">
              <i class="fab fa-youtube"></i>
              <h3>YouTube</h3>
              <p>Watch videos together</p>
            </div>
            <div class="feature-card">
              <i class="fab fa-spotify"></i>
              <h3>Spotify</h3>
              <p>Listen to music together</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Global Chat -->
      <div class="chat-interface" id="globalChat">
        <div class="chat-header">
          <div class="chat-title">
            <i class="fas fa-globe-americas"></i>
            <span>Global Chat</span>
            <span class="online-count" id="globalOnlineCount">0 online</span>
          </div>
          <button onclick="closeCurrentChat()" class="close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="chat-body" id="globalChatMessages"></div>
        <div class="chat-footer">
          <input type="text" id="globalChatInput" placeholder="Type your message to the world..." onkeypress="handleGlobalKeyPress(event)">
          <button onclick="sendGlobalMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>

      <!-- Friends Chat -->
      <div class="chat-interface" id="friendsChat">
        <div class="chat-header">
          <div class="chat-title">
            <i class="fas fa-users"></i>
            <span id="friendChatTitle">Friends Chat</span>
          </div>
          <button onclick="closeCurrentChat()" class="close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="chat-body" id="friendsChatMessages"></div>
        <div class="chat-footer">
          <input type="text" id="friendChatInput" placeholder="Type your message..." onkeypress="handleFriendKeyPress(event)">
          <button onclick="sendFriendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>

      <!-- AI Chat -->
      <div class="chat-interface" id="aiChat">
        <div class="chat-header">
          <div class="chat-title">
            <i class="fas fa-robot"></i>
            <span>AI Assistant</span>
          </div>
          <button onclick="closeCurrentChat()" class="close-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="chat-body" id="aiChatMessages"></div>
        <div class="chat-footer">
          <input type="text" id="aiChatInput" placeholder="Ask me anything..." onkeypress="handleAIKeyPress(event)">
          <button onclick="sendAIMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Container -->
  <div class="auth-container" id="authContainer">
    <div class="auth-box">
      <div class="auth-header">
        <i class="fas fa-comments"></i>
        <h2 id="authTitle">Sign In</h2>
      </div>
      <input type="text" id="username" placeholder="Username" style="display: none;">
      <input type="text" id="country" placeholder="Country" style="display: none;">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()" class="auth-btn" id="authBtn">
        <i class="fas fa-sign-in-alt"></i>
        Sign In
      </button>
      <p>Don't have an account? <span onclick="toggleAuth(true)">Register</span></p>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDrlV_ii4t4MjoBmqR0KhLHBUlkbL8pSXM",
      authDomain: "react-firechat-8abb6.firebaseapp.com",
      databaseURL: "https://react-firechat-8abb6-default-rtdb.firebaseio.com",
      projectId: "react-firechat-8abb6",
      storageBucket: "react-firechat-8abb6.firebasestorage.app",
      messagingSenderId: "694624056628",
      appId: "1:694624056628:web:9f9cc5538bc997cded2161"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Global Variables
    let isRegistering = false;
    let currentChatType = null;
    let currentUser = null;
    let onlineUsers = {};
    let selectedFriend = null;

    // Auth Functions
    function toggleAuth(registering) {
      isRegistering = registering;
      document.getElementById('authTitle').textContent = registering ? "Sign In" : "Join Friend Chat";
      document.getElementById('authBtn').innerHTML = registering ? 
        '<i class="fas fa-sign-in-alt"></i> Sign In' : 
        '<i class="fas fa-user-plus"></i> Join Friend Chat';
      document.getElementById('authBtn').onclick = registering ? login : register;
      document.querySelector('.auth-box p').innerHTML = registering ?
        `Don't have an account? <span onclick="toggleAuth(false)">Register</span>` :
        `Already have an account? <span onclick="toggleAuth(true)">Sign In</span>`;
      
      // Show/hide registration fields
      const usernameField = document.getElementById('username');
      const countryField = document.getElementById('country');
      if (registering) {
        usernameField.style.display = 'none';
        countryField.style.display = 'none';
      } else {
        usernameField.style.display = 'block';
        countryField.style.display = 'block';
      }
    }

    function register() {
      const username = document.getElementById('username').value;
      const country = document.getElementById('country').value;
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;

      if (!username || !country || !email || !pass) {
        alert('Please fill in all fields');
        return;
      }

      auth.createUserWithEmailAndPassword(email, pass)
        .then((userCredential) => {
          const user = userCredential.user;
          return db.ref(`users/${user.uid}`).set({
            username: username,
            country: country,
            email: email,
            createdAt: Date.now(),
            lastSeen: Date.now()
          });
        })
        .then(() => {
          document.getElementById('authContainer').style.display = 'none';
          updateUserInfo({ email: email, uid: auth.currentUser.uid });
          addUserToOnlineList();
        })
        .catch(err => alert(err.message));
    }

    function login() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      
      auth.signInWithEmailAndPassword(email, pass)
        .then((userCredential) => {
          document.getElementById('authContainer').style.display = 'none';
          updateUserInfo(userCredential.user);
          addUserToOnlineList();
        })
        .catch(err => alert(err.message));
    }

    function logout() {
      removeUserFromOnlineList();
      auth.signOut().then(() => {
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('userName').textContent = 'Guest User';
        document.getElementById('userCountry').textContent = 'Unknown';
        closeCurrentChat();
        clearOnlineUsers();
      });
    }

    function updateUserInfo(user) {
      currentUser = user;
      db.ref(`users/${user.uid}`).once('value')
        .then((snapshot) => {
          const userData = snapshot.val();
          if (userData) {
            document.getElementById('userName').textContent = userData.username;
            document.getElementById('userCountry').textContent = userData.country;
          } else {
            document.getElementById('userName').textContent = user.email.split('@')[0];
            document.getElementById('userCountry').textContent = 'Unknown';
          }
        });
    }

    // Online Users Management
    function addUserToOnlineList() {
      if (!currentUser) return;
      
      db.ref(`users/${currentUser.uid}`).once('value')
        .then((snapshot) => {
          const userData = snapshot.val();
          if (userData) {
            db.ref(`onlineUsers/${currentUser.uid}`).set({
              username: userData.username,
              country: userData.country,
              lastSeen: Date.now()
            });
          }
        });
    }

    function removeUserFromOnlineList() {
      if (currentUser) {
        db.ref(`onlineUsers/${currentUser.uid}`).remove();
      }
    }

    function clearOnlineUsers() {
      document.getElementById('usersList').innerHTML = '';
      document.getElementById('globalOnlineCount').textContent = '0 online';
    }

    // Listen for online users
    db.ref('onlineUsers').on('value', (snapshot) => {
      onlineUsers = snapshot.val() || {};
      updateOnlineUsersList();
      updateOnlineCount();
    });

    function updateOnlineUsersList() {
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';
      
      Object.keys(onlineUsers).forEach(uid => {
        if (uid !== currentUser?.uid) {
          const user = onlineUsers[uid];
          const userDiv = document.createElement('div');
          userDiv.className = 'online-user';
          userDiv.onclick = () => openFriendChat(uid, user.username);
          userDiv.innerHTML = `
            <div class="user-avatar">
              <i class="fas fa-user"></i>
            </div>
            <div class="user-details">
              <div class="username">${user.username}</div>
              <div class="country">${user.country}</div>
            </div>
            <div class="online-indicator"></div>
          `;
          usersList.appendChild(userDiv);
        }
      });
    }

    function updateOnlineCount() {
      const count = Object.keys(onlineUsers).length;
      document.getElementById('globalOnlineCount').textContent = `${count} online`;
    }

    // Search Functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const users = document.querySelectorAll('.online-user');
      
      users.forEach(user => {
        const username = user.querySelector('.username').textContent.toLowerCase();
        const country = user.querySelector('.country').textContent.toLowerCase();
        
        if (username.includes(searchTerm) || country.includes(searchTerm)) {
          user.style.display = 'flex';
        } else {
          user.style.display = 'none';
        }
      });
    });

    // Chat Functions
    function openGlobalChat() {
      closeCurrentChat();
      currentChatType = 'global';
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('globalChat').style.display = 'flex';
      
      // Listen for global messages
      db.ref('globalMessages').limitToLast(50).on('child_added', (snapshot) => {
        const message = snapshot.val();
        addGlobalMessage(message);
      });
      
      addMessage('globalChatMessages', 'System', 'Welcome to Global Chat! Connect with people from around the world.', 'system');
    }

    function openYouTube() {
      window.open('https://www.youtube.com', '_blank');
    }

    function openSpotify() {
      window.open('https://open.spotify.com', '_blank');
    }

    function openFriendChat(friendId = null, friendName = null) {
      closeCurrentChat();
      currentChatType = 'friends';
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('friendsChat').style.display = 'flex';
      
      if (friendId && friendName) {
        selectedFriend = { id: friendId, name: friendName };
        document.getElementById('friendChatTitle').textContent = `Chat with ${friendName}`;
        
        // Load chat history with this friend
        const chatId = generateChatId(currentUser.uid, friendId);
        db.ref(`privateMessages/${chatId}`).limitToLast(50).on('child_added', (snapshot) => {
          const message = snapshot.val();
          addFriendMessage(message);
        });
        
        addMessage('friendsChatMessages', 'System', `You're now chatting with ${friendName}.`, 'system');
      } else {
        selectedFriend = null;
        document.getElementById('friendChatTitle').textContent = 'Friends Chat';
        addMessage('friendsChatMessages', 'System', 'Click on a user to start chatting.', 'system');
      }
    }

    function generateChatId(user1, user2) {
      return [user1, user2].sort().join('_');
    }

    function openAIChat() {
      closeCurrentChat();
      currentChatType = 'ai';
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('aiChat').style.display = 'flex';
      addMessage('aiChatMessages', 'AI Assistant', 'Hello! I\'m your AI assistant. How can I help you today?', 'ai');
    }

    function closeCurrentChat() {
      document.getElementById('welcomeScreen').style.display = 'flex';
      document.getElementById('globalChat').style.display = 'none';
      document.getElementById('friendsChat').style.display = 'none';
      document.getElementById('aiChat').style.display = 'none';
      currentChatType = null;
      selectedFriend = null;
      
      // Remove listeners
      db.ref('globalMessages').off();
      db.ref('privateMessages').off();
    }

    // Key press handlers
    function handleGlobalKeyPress(e) {
      if (e.key === 'Enter') {
        sendGlobalMessage();
      }
    }

    function handleFriendKeyPress(e) {
      if (e.key === 'Enter') {
        sendFriendMessage();
      }
    }

    function handleAIKeyPress(e) {
      if (e.key === 'Enter') {
        sendAIMessage();
      }
    }

    function sendGlobalMessage() {
      const input = document.getElementById('globalChatInput');
      const message = input.value.trim();
      
      if (!message || !currentUser) {
        return;
      }
      
      db.ref(`users/${currentUser.uid}`).once('value')
        .then((snapshot) => {
          const userData = snapshot.val();
          const messageData = {
            sender: currentUser.uid,
            username: userData.username,
            country: userData.country,
            text: message,
            timestamp: Date.now()
          };
          return db.ref('globalMessages').push(messageData);
        })
        .then(() => {
          input.value = '';
        })
        .catch(err => {
          console.error('Error sending message:', err);
          alert('Error sending message. Please try again.');
        });
    }

    function addGlobalMessage(message) {
      const container = document.getElementById('globalChatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.sender === currentUser?.uid ? 'user-message' : 'other-message'}`;
      
      const isOwnMessage = message.sender === currentUser?.uid;
      const icon = isOwnMessage ? 'fas fa-user' : 'fas fa-globe';
      
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-header">
            <i class="${icon}"></i>
            <span class="sender">${message.username}</span>
            <span class="country">${message.country}</span>
            <span class="time">${new Date(message.timestamp).toLocaleTimeString()}</span>
          </div>
          <div class="message-text">${message.text}</div>
        </div>
      `;
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    function sendFriendMessage() {
      const input = document.getElementById('friendChatInput');
      const message = input.value.trim();
      
      if (!message || !currentUser || !selectedFriend) {
        return;
      }
      
      const chatId = generateChatId(currentUser.uid, selectedFriend.id);
      
      db.ref(`users/${currentUser.uid}`).once('value')
        .then((snapshot) => {
          const userData = snapshot.val();
          const messageData = {
            sender: currentUser.uid,
            senderName: userData.username,
            recipient: selectedFriend.id,
            recipientName: selectedFriend.name,
            text: message,
            timestamp: Date.now()
          };
          return db.ref(`privateMessages/${chatId}`).push(messageData);
        })
        .then(() => {
          input.value = '';
        })
        .catch(err => {
          console.error('Error sending friend message:', err);
          alert('Error sending message. Please try again.');
        });
    }

    function addFriendMessage(message) {
      const container = document.getElementById('friendsChatMessages');
      const messageDiv = document.createElement('div');
      
      const isOwnMessage = message.sender === currentUser?.uid;
      messageDiv.className = `message ${isOwnMessage ? 'user-message' : 'other-message'}`;
      
      const senderName = isOwnMessage ? 'You' : message.senderName;
      const icon = isOwnMessage ? 'fas fa-user' : 'fas fa-user-friends';
      
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-header">
            <i class="${icon}"></i>
            <span class="sender">${senderName}</span>
            <span class="time">${new Date(message.timestamp).toLocaleTimeString()}</span>
          </div>
          <div class="message-text">${message.text}</div>
        </div>
      `;
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    function sendAIMessage() {
      const input = document.getElementById('aiChatInput');
      const message = input.value.trim();
      
      if (!message) {
        return;
      }
      
      addMessage('aiChatMessages', 'You', message, 'user');
      input.value = '';
      
      // Simulate AI response
      setTimeout(() => {
        const responses = [
          "That's an interesting question! Let me think about that...",
          "I can help you with various topics and provide useful information.",
          "Interesting! Here's what I know about that subject.",
          "I'm here to assist you with any questions or tasks you might have.",
          "That's a great point! Let me provide some insights on that.",
          "I'd be happy to help you explore that topic further."
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        addMessage('aiChatMessages', 'AI Assistant', randomResponse, 'ai');
      }, 1000);
    }

    function addMessage(containerId, sender, text, type) {
      const container = document.getElementById(containerId);
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      
      const icon = type === 'user' ? 'fas fa-user' : 
                   type === 'ai' ? 'fas fa-robot' : 
                   type === 'system' ? 'fas fa-info-circle' : 'fas fa-user-friends';
      
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-header">
            <i class="${icon}"></i>
            <span class="sender">${sender}</span>
            <span class="time">${new Date().toLocaleTimeString()}</span>
          </div>
          <div class="message-text">${text}</div>
        </div>
      `;
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    // Check auth state on load
    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById('authContainer').style.display = 'none';
        updateUserInfo(user);
        addUserToOnlineList();
      } else {
        document.getElementById('authContainer').style.display = 'flex';
        clearOnlineUsers();
      }
    });

    // Update last seen when user leaves
    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        db.ref(`users/${currentUser.uid}/lastSeen`).set(Date.now());
        removeUserFromOnlineList();
      }
    });
  </script>
</body>
</html>